# 编码规范与安全检查

## 1. 目的

### 1.1 预防漏洞源头
- 在代码编写阶段消除常见漏洞（SQL注入、XSS、命令注入等），避免安全缺陷进入生产环境。
- 修复开发阶段漏洞成本远低于生产环境。

### 1.2 统一安全实践
- 强制使用安全函数（参数化查询、输出编码），禁止危险操作（eval()、动态拼接SQL/命令）。
- 提供明确“该做/禁止”清单，降低认知差异。

### 1.3 满足合规要求
- 符合国家及行业标准安全开发流程要求。
- 提供代码审查记录作为审计证据。

### 1.4 提升开发效率
- 提前发现漏洞，减少安全返工。
- 可对接自动化SAST工具（如SonarQube）。

### 1.5 建立安全文化
- 内化最小权限、加密、输入验证等安全原则。
- 为新开发者提供可落地示例。

---

## 2. 输入验证
2.1 所有数据验证必须在可信系统（服务器端）执行。  
2.2 识别所有数据源，并对不可信源（客户端、数据库、文件流等）进行验证。  
2.3 建立集中输入验证规则库。  
2.4 明确字符集（UTF-8）并在解码后验证扩展字符集。  
2.5 输入规范化处理（如统一编码），丢弃未通过验证的数据。  
2.6 验证请求和响应头信息只含 ASCII 字符。  
2.7 验证重定向输入，防止绕过验证的攻击。  
2.8 数据类型、范围、长度验证必须严格执行。  
2.9 优先采用白名单验证。  
2.10 对危险字符（如 `< > " ' % & + \` ）执行额外控制（输出编码、使用安全API）。  
2.11 单独验证空字节（`%00`）、换行符（`%0d, %0a`）、路径替代字符（`../` 或双编码形式）。  
2.12 **时间侧信道防护**：签名比较禁止短路比较，必须使用恒定时间函数（如 Java: `MessageDigest.isEqual`，Python: `hmac.compare_digest`）。

## 3. 输出编码
3.1 所有输出编码必须在可信系统执行。  
3.2 使用标准、测试过的输出编码规则。  
3.3 对不可信数据进行语义输出编码（HTML实体、SQL、XML、LDAP等）。  
3.4 操作系统命令输出必须净化不可信数据。

## 4. 身份验证与密码管理
4.1 除公开内容外，所有资源必须身份验证。  
4.2 身份验证必须在可信系统执行，优先使用标准库和服务。  
4.3 集中实现身份验证逻辑，隔离资源请求。  
4.4 所有密码必须使用 **单向 salted 哈希**（推荐使用 `bcrypt/argon2/scrypt`）存储。  
4.5 禁止使用 `MD5/SHA1/SHA256` 单独存储密码。  
4.6 密码比较必须恒定时间，防止时间侧信道攻击。  
4.7 错误提示信息统一（如“用户名或密码错误”）。  
4.8 账户连续多次失败登录应锁定，防暴力攻击。  
4.9 密码复杂度与长度策略：最少16字符或多单词密码短语。  
4.10 临时密码/重置链接短期有效，使用后必须修改。  
4.11 阻止密码重复使用和频繁更改攻击。  
4.12 关键操作前需二次身份验证；重要账户推荐使用多因子认证。  
4.13 第三方身份验证代码需审查，避免被恶意代码影响。  
4.14 密码输入在客户端必须模糊显示，不允许浏览器记住。

## 5. 会话管理
5.1 会话管理使用服务器 or 框架控制。  
5.2 会话标识符必须在可信系统生成并随机。  
5.3 设置域、路径限制，HTTP Cookie 设置 `Secure` & `HttpOnly`。  
5.4 注销操作必须确实终止会话。  
5.5 会话超时控制在业务允许范围内，推荐短会话，周期性重新验证权限。  
5.6 同一用户禁止并发登录；登录时若从HTTP切换到HTTPS，生成新会话标识符。  
5.7 会话标识符不得出现在 URL、日志或错误信息中。  
5.8 高敏感操作使用强随机令牌或参数防止 CSRF。

## 6. 访问控制
6.1 使用可信系统对象决定授权。  
6.2 全站统一访问控制机制，包括外部授权服务调用。  
6.3 访问失败处理安全，缺少配置信息时拒绝访问。  
6.4 授权控制覆盖所有请求，包括 AJAX、Flash 等富客户端请求。  
6.5 特权逻辑与普通代码隔离。  
6.6 资源访问严格限制，只允许授权用户访问受保护 URL、功能、数据、配置。  
6.7 客户端存储状态数据必须加密，服务器端验证完整性。  
6.8 交易数量/时间限制防止自动化攻击。  
6.9 `Referer` 头只能作补偿性检查，不可做身份验证。  
6.10 周期性重新验证用户权限，注销权限变化用户。  
6.11 账户审计：失效账户及时注销，服务账号最小权限。

## 7. 加密规范
7.1 所有加密操作必须在可信系统执行。  
7.2 保护秘密信息免受未授权访问。  
7.3 加密模块错误必须安全处理。  
7.4 随机数生成器必须使用验证过的算法生成随机数、GUID 等。  
7.5 密钥管理必须有完整政策与流程。

## 8. 错误处理和日志
8.1 不在错误响应中泄露系统、会话或账号信息。  
8.2 避免显示调试或堆栈跟踪信息，使用通用错误消息和定制页面。  
8.3 日志记录在可信系统执行，记录安全事件成功/失败操作。  
8.4 日志中不保存敏感信息（密码、会话标识符）。  
8.5 记录失败输入验证、身份验证尝试、访问控制失败、状态修改异常、过期会话尝试、系统异常、管理操作、安全配置更改、加密模块错误。  
8.6 使用哈希验证日志完整性。  
8.7 访问日志仅授权人员可查看。

## 9. 数据保护
9.1 最小权限原则访问数据和功能。  
9.2 服务器缓存或临时敏感数据必须受保护并及时清除。  
9.3 高度机密信息存储必须加密。  
9.4 服务器端源代码禁止用户下载。  
9.5 客户端不得以明文保存密码或敏感信息。  
9.6 禁止 HTTP GET 请求传输敏感信息。  
9.7 禁止表单自动填充或客户端缓存敏感网页。  
9.8 数据不再需要时及时删除。  
9.9 服务器端敏感信息访问需要严格控制。  
9.10 明确各类数据（尤其是敏感/隐私数据）的最长保留期限，过期后必须自动清除或匿名化。  
9.11 支持用户特定请求（如 GDPR/CCPA 要求），在验证身份后删除其个人信息（“被遗忘权”）。

## 10. 通讯安全
10.1 所有敏感信息必须加密传输，TLS 保护所有连接。  
10.2 TLS 证书有效且正确安装，禁止回退到不安全连接。  
10.3 连接外部系统时过滤 `HTTP Referer` 中敏感信息。  
10.4 传输字符编码明确。

## 11. 系统配置
11.1 服务器、框架和组件使用最新版本并打全补丁。  
11.2 关闭目录列表、禁用不必要 HTTP 方法，移除测试代码和不需要功能。  
11.3 Web 服务器和应用隐藏版本信息。  
11.4 开发环境与生产隔离，仅供明确授权的人员访问。  
11.5 使用软件变更管理和资产管理系统。  
11.6 系统账户尽量最小权限。  
11.7 **凭据管理**：严禁将数据库/第三方服务密码、API-Key、证书等敏感信息存放在源代码库中；运行时应通过环境变量或专用的密钥管理服务（如 Secret Manager）引入。

## 12. 数据库安全
12.1 使用强类型参数化查询。  
12.2 输入验证和输出编码处理元字符，失败则拒绝执行命令。  
12.3 使用最小权限数据库账户，其安全凭据管理遵循第11章的通用凭据规范。  
12.4 使用存储过程和最小化权限访问表。  
12.5 移除默认管理员密码、禁用不必要默认账户及功能。

## 13. 文件管理
13.1 上传文件前必须身份验证。  
13.2 限制上传类型，检查文件报头验证类型。  
13.3 文件不存储在 Web 根目录，关闭上传目录执行权限。  
13.4 使用白名单控制引用文件，禁止绝对路径传递给客户端。  
13.5 用户上传文件扫描病毒与恶意软件。

## 14. 内存管理
14.1 输入输出数据控制，缓存大小验证，防止溢出。  
14.2 使用安全函数避免已知漏洞。  
14.3 释放资源时正确清空内存，不依赖垃圾回收。  
14.4 在可能的情况下使用不可执行堆栈。

## 15. 通用编码规范
15.1 使用已验证托管库，避免非托管代码。  
15.2 避免将用户数据传递给动态执行功能或操作系统 shell。  
15.3 检查第三方库安全性并执行安全更新。  
15.4 初始化所有变量，正确处理权限提升。  
15.5 防止竞态条件、共享资源保护。  
15.6 限制用户生成或修改代码。

## 16. 额外补充（现代 Web/API 安全）
16.1 Token/API Key 使用高随机性、最小权限、短期有效、支持吊销。  
16.2 签名和 Token 比较使用恒定时间函数，防时间侧信道攻击。  
16.3 Web 接口防止 CSRF，Cookie 设置 `Secure` & `HttpOnly`。  
16.4 避免在日志、URL、错误信息中泄露 Token 或会话 ID。  
16.5 富客户端请求（AJAX/SPA/WebSocket）也必须执行服务端授权验证。

## 17. 运维与基础设施安全
17.1 企业必须指定明确的安全负责人。  
17.2 生产环境密码（服务器、数据库等）仅限最少必要人员知晓，且必须符合高强度要求（见第4章）。  
17.3 所有运维客户端及办公终端必须安装杀毒软件并保持特征库更新。  
17.4 服务器仅开放业务绝对必需的端口，默认拒绝所有其他连接。  
17.5 建立定期机制，检查并应用服务器操作系统、中间件及第三方依赖库的安全补丁。  
17.6 每三个月执行一次资产盘点，确认所有资产的可连接性及运行健康状态。  
17.7 制定服务故障/挂掉的应急恢复预案，并定期进行故障演习以验证预案有效性。

## 18. 日常办公与人员安全
18.1 所有计算机及办公设备必须设置不易被猜出的强密码，且系统设定无操作 10 分钟后自动锁定屏幕。  
18.2 离开工位时执行“清洁桌面”政策，确保敏感文档归档、屏幕已锁定。  
18.3 不轻信不明来源的邮件、链接或附件，定期进行内部钓鱼邮件演练。  
18.4 严禁共享账号，严禁将个人密码写在便签或保存在不安全文件中。  
18.5 对外来及未授权人员进入办公区域保持警惕，防止尾随。

---

### 员工确认与承诺

本人已详细阅读并充分理解上述《安全规范文档》的内容。本人承诺在日常工作及系统开发维护过程中，严格遵守文档中的各项规定，发现安全隐患及时上报，并对涉及的敏感信息履行保密义务。

**员工姓名：** ____________________  
**所属部门：** ____________________  
**签署日期：** 20 __ 年 __ 月 __ 日